/*! Logic 26-03-2015 */
function logPlay(){_gaq.push(["_trackEvent","Button","Play"])}function moveModal(){var a=$(".modal"),b=$(app.canvas).offset();a.offset({top:b.top-5,left:b.left-5})}function replaceAt(a,b,c){return a.substr(0,b)+c+a.substr(b+c.length)}function start(){new Date;window.app=new SL.Game({canvas:document.getElementById("GameCanvas")}),app.assetCollection=new SL.AssetCollection("res/assets.json",app,function(){var a=new SL.Scene("loading",[],function(){},app);a.addEntity(new SL.Loader({assetCollection:app.assetCollection,screenSize:SCREEN_SIZE,loadCallback:function(){app.transitionScene("game")},barColor:"blue",textColor:"green"}));var b=new SL.Scene("game",[],function(){for(app.currentScene.addEntity({type:"background",sprite:new PIXI.Sprite(app.assetCollection.getTexture("background")),update:function(){for(;app.currentScene.getEntitiesByTag("food").length<5;)app.currentScene.addEntity(new Food({position:(new SCREEN_SIZE.clone).randomize()}))}});app.currentScene.getEntitiesByTag("food").length<5;)app.currentScene.addEntity(new Food({position:(new SCREEN_SIZE.clone).randomize()}));for(var a=0;15>a;a++)app.currentScene.addEntity(new Creature({position:(new SCREEN_SIZE.clone).randomize(),inputs:["radarFood"],logicCircuit:seedCircuit({inputs:4,outputs:4,genomeLength:64}),generation:a}));app.currentScene.addEntity(new Evolver)},app);app.addScene(a),app.addScene(b),app.transitionScene("loading"),app.start()})}function Creature(a){function b(){for(var a=[],b=app.currentScene.getEntitiesByTag("food"),d=b[0],e=0;e<c.inputs.length;e++)if("radarFood"===c.inputs[e]){for(var f=1;f<b.length;f++)c.sprite.position.distance(b[f].sprite.position)<c.sprite.position.distance(d.sprite.position)&&(d=b[f]);c.sprite.position.x>d.sprite.position.x?a.push(0,1):a.push(1,0),c.sprite.position.y>d.sprite.position.y?a.push(0,1):a.push(1,0)}else"radarEdge"===c.inputs[e]&&(a.push(c.sprite.position.x<=15?1:0),a.push(c.sprite.position.x>=SCREEN_SIZE.x-15?1:0),a.push(c.sprite.position.y<=15?1:0),a.push(c.sprite.position.y>=SCREEN_SIZE.y-15?1:0));return a}var c=this;c.tag="creature",c.health=5,c.score=0,c.timeLived=0,c.generation=a.generation||0,c.sprite=new PIXI.Sprite(app.assetCollection.getTexture(c.tag)),c.sprite.anchor.x=.5,c.sprite.anchor.y=.5,c.sprite.position=a.position,c.sprite.rotation=0,c.inputs=a.inputs,c.logicCircuit=a.logicCircuit,c.update=function(){var a,d,e=0,f=0;if(c.health>=0){c.timeLived+=app.deltaTime,c.logicCircuit.input=b(),d=app.currentScene.getEntitiesByTag("food"),a=c.logicCircuit.resolve(),a[0]&&(c.sprite.position.x+=125*app.deltaTime,e+=125),a[1]&&(c.sprite.position.x-=125*app.deltaTime,e-=125),a[2]&&(c.sprite.position.y+=125*app.deltaTime,f+=125),a[3]&&(c.sprite.position.y-=125*app.deltaTime,f-=125),c.sprite.position.x<0&&(c.sprite.position.x=SCREEN_SIZE.x),c.sprite.position.x>SCREEN_SIZE.x&&(c.sprite.position.x=0),c.sprite.position.y<0&&(c.sprite.position.y=SCREEN_SIZE.y),c.sprite.position.y>SCREEN_SIZE.y&&(c.sprite.position.y=0),c.health-=app.deltaTime;for(var g=0;g<d.length;g++)c.sprite.position.distance(d[g].sprite.position)<=15&&(c.health+=2,d[g].eaten=!0,c.score+=200);0===e&&0===f&&(c.health=0,c.score=0),c.score+=1,GENERATION_COLORS[c.generation]?c.sprite.tint=GENERATION_COLORS[c.generation]:GENERATION_COLORS.push(16777215*Math.random())}}}function Food(a){var b=this;b.tag="food",b.sprite=new PIXI.Sprite(app.assetCollection.getTexture(b.tag)),b.sprite.anchor.x=.5,b.sprite.anchor.y=.5,b.sprite.position=a.position,b.sprite.rotation=0,b.eaten=!1,b.update=function(){b.eaten&&app.currentScene.removeEntity(b)}}function LogicGate(a){var b=this;b.tag="gate",b.type=a.type,b.sources=[],b.circuit=a.circuit,b.circuitIndex=a.circuitIndex,b.out=0,b.resolve=function(){var a="gate"===b.sources[0].tag?b.sources[0].out:b.circuit.input[b.sources[0]],c="gate"===b.sources[1].tag?b.sources[1].out:b.circuit.input[b.sources[1]];switch(b.type){case"AND":b.out=a&&c?1:0;break;case"OR":b.out=a||c?1:0;break;case"NOT":b.out=a?0:1;break;case"NAND":b.out=a&&c?0:1;break;case"NOR":b.out=a||c?0:1;break;case"XOR":b.out=!a&&!c||a&&c?0:1;break;default:b.out=0}},b.clone=function(){return{tag:"gate",type:b.type,sources:[],circuit:{},circuitIndex:b.circuitIndex,out:0}}}function LogicCircuit(a){var b=this;b.genome=a,b.gates=[],b.gateTypes=["AND","OR","NOT","NAND","NOR","XOR"],b.input=[],b.outputs=[];for(var c=0;c<b.genome.length;c++)b.gates.push(new LogicGate({type:b.gateTypes[parseInt(b.genome[c])],circuit:b,circuitIndex:c}));b.addOutput=function(a){b.outputs.push(b.gates[a])},b.setOutputs=function(a){b.outputs=[];for(var c=0;c<a.length;c++)b.outputs.push(b.gates[a[c]])},b.resolve=function(a){var d=[];for(b.input=a?a:b.input,c=0;c<b.gates.length;c++)b.gates[c].resolve();for(c=0;c<b.outputs.length;c++)d.push(b.outputs[c].out);return d},b.clone=function(){for(var a={genome:b.genome,gates:[],gateTypes:b.gateTypes,input:[],outputs:[]},c=0;c<b.gates.length;c++)a.gates.push(b.gates[c].clone());for(c=0;c<a.gates.length;c++)a.gates[c].circuit=a,a.gates[c].sources[0]="gate"===b.gates[c].sources[0].tag?a.gates[b.gates[c].sources[0].circuitIndex]:b.gates[c].sources[0],a.gates[c].sources[1]="gate"===b.gates[c].sources[1].tag?a.gates[b.gates[c].sources[1].circuitIndex]:b.gates[c].sources[1];for(c=0;c<b.outputs.length;c++)a.outputs.push(a.gates[b.outputs[c].circuitIndex]);return a}}function seedCircuit(a){for(var b,c,d=a.inputs,e=a.outputs,f=a.genomeLength,g="",h={},i=!1,j=0;f>j;j++)g+=Math.floor(6*Math.random());c=new LogicCircuit(g);for(var j=0;d>j;j++){for(;!i;)b=Math.floor(Math.random()*f),c.gates[b].sources[0]||(c.gates[b].sources[0]=j,i=!0);i=!1,c.input.push(0)}for(j=0;e>j;j++){for(;!i;)b=Math.floor(Math.random()*f),h[b]||(c.addOutput(b),h[b]=!0,i=!0);i=!1}for(j=0;f>j;j++){for(;!c.gates[j].sources[0];)b=Math.floor(Math.random()*f),b!==j&&(c.gates[j].sources[0]=c.gates[b]);for(;!c.gates[j].sources[1];)b=Math.floor(Math.random()*f),b!==j&&(c.gates[j].sources[1]=c.gates[b])}return c}function Evolver(){var a=this;a.generation=0,a.mutationRate=.01,a.generationalRate=.2,a.lastBestCircuit=app.currentScene.getEntitiesByTag("creature")[0].logicCircuit.clone(),a.lastBestFitness=0,a.gateTypes=["AND","OR","NOT","NAND","NOR","XOR"],a.tellInterval=5,a.timeToTell=a.tellInterval,a.update=function(){for(var b=app.currentScene.getEntitiesByTag("creature"),c=b[0],d=0;d<b.length;d++)b[d].health<=0&&(Math.random()<=a.generationalRate?(b[d].logicCircuit=seedCircuit({inputs:4,outputs:4,genomeLength:64}),b[d].sprite.position=SCREEN_SIZE.clone().randomize(),a.generation++,b[d].generation=a.generation):a.mutateCreature(b[d])),b[d].score>a.lastBestFitness&&(a.lastBestFitness=b[d].score,a.lastBestCircuit=b[d].logicCircuit.clone()),b[d].score>c.score&&(c=b[d]);for(d=0;d<b.length;d++)b[d].sprite.alpha=b[d].entityID===c.entityID?1:.1;a.timeToTell-=app.deltaTime,a.timeToTell<=0&&(a.timeToTell=a.tellInterval,console.log("Generation: "+a.generation,"\nBest Fitness: "+a.lastBestFitness,"\nLeading EntityID: "+c.entityID,"\nLeading Time Lived: "+c.timeLived.toPrecision(2),"\nLeading Fitness: "+c.score))},a.mutateCreature=function(b){for(var c=a.lastBestCircuit,d=b.logicCircuit,e=0;e<c.gates.length;e++)d.gates[e].type=c.gates[e].type,d.gates[e].sources[0]="gate"===c.gates[e].sources[0].tag?d.gates[c.gates[e].sources[0].circuitIndex]:c.gates[e].sources[0],d.gates[e].sources[1]="gate"===c.gates[e].sources[1].tag?d.gates[c.gates[e].sources[1].circuitIndex]:c.gates[e].sources[1];for(e=0;e<d.gates.length;e++)Math.random()<=a.mutationRate&&(d.gates[e].type=a.gateTypes[Math.floor(6*Math.random())]),Math.random()<=a.mutationRate&&(d.gates[e].sources[0]=Math.random()<=.5?Math.floor(Math.random()*d.input.length):d.gates[Math.floor(Math.random()*d.gates.length)]),Math.random()<=a.mutationRate&&(d.gates[e].sources[1]=Math.random()<=.5?Math.floor(Math.random()*d.input.length):d.gates[Math.floor(Math.random()*d.gates.length)]);b.health=5,b.score=0,b.sprite.position=SCREEN_SIZE.clone().randomize(),b.timeLived=0}}var window,SL;window?SL=sugarLab:(GLOBAL.window={},require("./lib/SugarLab.js"),SL=GLOBAL.window.sugarLab);var SCREEN_SIZE=new SL.Vec2(800,600),GENERATION_COLORS=[16711680,65280,255,15728640,61440,240,983040,3840,15,16776960,16711935,65535,15728655,15728880,15732480];